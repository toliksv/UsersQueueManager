# Модуль 5 Микросервисная архитектура
## Управление очередями клиентов за товарами.

### Краткое описание
#### Папка Core
 Содержит общие контракты и компоненты.
 ##### UserQueueManager.Contracts
  - Data - общие dto;
  - FaultHandlers  - Интерфейсы - обертки над контроллерами для применения политики CircuitBreaker;
  - Storage - Интерфейсы хранение (хранилище и репозиторий) связки товар - очередь пользователей; 
  - Web - Интерфейсы контроллеров к сервисам (как к оркестратору, так и к мониторинга);
 ##### UserQueueManager.Core
  - FaultHandlers - Реализации обертки над контроллером оркестратора для политики CircuitBreaker;
  - Infrastructure - Методы расширения для регистрации обработчиков в DI.   
  - Storage - Реализация хранилища связки товар - очередь пользователей, это общая реализация для всех сервисов.
#### Папка Infractructure
Содержит инфраструктурные проекты, зависимые от технологий и пр.
#####   UserQueueManager.FileRepository
 Реализация файлового репозитория для хранилища.
  - Storage - Реализация репозитория и опции
  - Infrastructure - Методы расширения для регистрации обработчиков в DI.
##### UsersQueueManager.RemotePlatform
 Библиотека для имитации ответа удаленной онлайн платформы и реализация его обработчика.
 - Infrastructure - Методы расширения для регистрации обработчиков в DI.
 - RemotePlatform - Интерфейс и реализация имитации ответа удаленной платформы.
 В корне обработчик такого ответа.

#### Папка Services
Сами три сервиса. Один оркестратор и два сервиса мониторинга.

##### UserQueueManager.[A|B]Service
Сервисы мониторинга удаленной платформы
- Controllers - реализация контроллера сервиса (согласно интерфейсу, объявленному в UserQueueManager.Contracts)
- Infrastructure - Методы расширения для регистрации обработчиков в DI.

##### UserQueueManager.Orchestrator
Оркестратор.
- Controllers - реализация контроллера сервиса (согласно интерфейсу, объявленному в UserQueueManager.Contracts);
- Сore.ProductQueue - интерфейс и реализация обработчика хранилища связок товар - очередь пользователей;
- Core.ProductRoutes - маршрутизация товар - сервис, один товар мониторит всегда только один сервис;
- Core.RequestProcessing - асинхронная обработка событий сервисов мониторинга;
- Infrastructure - Методы расширения для регистрации обработчиков в DI.
- Options - настроки для клиентов сервисов мониторинга и так-же распределение товаров между сервисами.

#### Папка Tests
Я ее закомичу для себя, но смотреть ее не нужно. 

### Немного примечаний.
 Все-таки не до конца понял задачу, поэтому сервисы мониторинга делят между собой товары и есть машрутизация. Как и написал один товар в одном сервисе.
 Чтобы с чего-то начинать, написал в оркестраторе процедуру инициализации начальных данных. Оркестратор считает очереди и товары из appsettings, создаст свое хранилище и роздаст
 очереди сервисам. Последний в свою очередь создадут свои хранилища.
  При первом запуске поэтому лучше сначала запустить сервисы мониторинга, а потом оркестратор, политики повтором запроса я не писал, не успею. В результате первого запуска должны появиться три файла:
   ProductsQueue.jsn - файловое хранилище оркестратора.
   AServiceQueue.jsn - файловое хранилище А сервиса
   BServiceQueue.jsn - файловое хранилище B сервиса.
Повторный запуск должнен работать на созданных файлах.
Если файлы удалить - инициализация запуститься заного.

Результаты можно смотреть в файлах, можно в консоли. Изначально ид пользователей выстроены по возрастанию. ид брал с 1-12, далее повторябтся. Нумерация по всем очередям сквозная.
В целом видно в appsettings оркестратора.

Мне кажется, консистентность в таком виде соблюдать тяжело. Хорошо если товары появляются не часто, при интенсивном бронировании из-за лагов в обработке, очереди у сервисов мониторинга будут обновляться с запаздыванием.
Добавление в очередь пользователя сделать не успел, там вопросов больше, чем ответов )

Буду рад Вашим замечаниям. Спасибо.







